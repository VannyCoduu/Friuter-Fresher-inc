<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងការលក់ផ្លែឈើ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Preahvihear&display=swap');
        body {
            font-family: 'Preahvihear', sans-serif;
            background-color: #f7fee7; /* Lighter shade of the palette */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Message box styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 1rem;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        /* CSS for PDF export and print */
        .pdf-export-container {
            display: none;
            width: 29.7cm; /* A4 landscape width */
            height: 21cm; /* A4 landscape height */
            box-sizing: border-box;
            position: relative;
        }
        .pdf-export-container.visible {
            display: flex;
            flex-direction: row; 
            justify-content: center;
            align-items: flex-start;
            padding: 1cm;
        }
        .pdf-invoice-content {
            box-shadow: none;
            border: none;
            width: 13.85cm; /* Adjusted width for A5 landscape side by side */
            padding: 0.5cm;
            box-sizing: border-box;
            border: 1px solid #007200; /* Dark green border */
        }
        .signature-line {
            border-bottom: 1px solid #6b7280;
        }
        .dotted-divider {
            border-left: 2px dashed #d1d5db;
            height: 100%;
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        .qr-code-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        .qr-code-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
    </style>
</head>
<body class="bg-lime-50 min-h-screen flex items-center justify-center p-4">
    <div id="main-app" class="bg-white shadow-xl rounded-2xl p-6 md:p-10 w-full max-w-5xl">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-lime-800 mb-6" style="color: #006400;">កម្មវិធីគ្រប់គ្រងការលក់ផ្លែឈើ</h1>
        <p class="text-center text-gray-600 mb-2">សូមស្វាគមន៍! ប្រើកម្មវិធីនេះដើម្បីគ្រប់គ្រងការលក់ផ្លែឈើ។</p>
        <p class="text-center text-gray-600 mb-4">អ្នករៀបរៀងកម្មវិធី៖​ ហ៊ាន សុម៉ូនី​ ទំនាក់ទំនងសរសេរកម្មវិធីតាមលេខទូរស័ព្ទ៖ ០៩៦៧២៤៨៨៨១</p>

        <div class="flex border-b mb-8" style="border-color: #9ef01a;">
            <button class="tab-button flex-1 py-3 px-2 md:px-6 text-center text-lg md:text-xl font-semibold rounded-t-lg transition-colors duration-200 ease-in-out bg-lime-100 text-lime-800 border-b-4" style="background-color: #70e000; color: white; border-color: #008000;" data-tab="order">
                កត់ត្រាការកម្ម៉ង់
            </button>
            <button class="tab-button flex-1 py-3 px-2 md:px-6 text-center text-lg md:text-xl font-semibold rounded-t-lg transition-colors duration-200 ease-in-out hover:bg-lime-50" style="color: #007200;" data-tab="invoice">
                វិក្កយបត្រ
            </button>
            <button class="tab-button flex-1 py-3 px-2 md:px-6 text-center text-lg md:text-xl font-semibold rounded-t-lg transition-colors duration-200 ease-in-out hover:bg-lime-50" style="color: #007200;" data-tab="preorders">
                បញ្ជីកម្ម៉ង់មុន
            </button>
        </div>

        <div id="order" class="tab-content active">
            <h2 class="text-2xl font-bold mb-4" style="color: #006400;">កត់ត្រាការកម្ម៉ង់</h2>
            <form id="orderForm" class="space-y-4">
                <div class="flex items-end gap-2">
                    <div class="flex-1">
                        <label for="customerName" class="block text-sm font-medium text-gray-700">ឈ្មោះអតិថិជន:</label>
                        <select id="customerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-lime-500 focus:ring focus:ring-lime-200 focus:ring-opacity-50 p-2">
                        </select>
                    </div>
                    <button type="button" onclick="showCustomerModal('add')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full text-xs transition-transform transform hover:scale-105 whitespace-nowrap" style="background-color: #38b000;">
                        បន្ថែមឈ្មោះអតិថិនថ្មី
                    </button>
                    <button type="button" onclick="showCustomerModal('delete')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full text-xs transition-transform transform hover:scale-105 whitespace-nowrap">
                        លុបឈ្មោះអតិថិជន
                    </button>
                </div>
                <div>
                    <label for="orderDate" class="block text-sm font-medium text-gray-700">កាលបរិច្ឆេទ:</label>
                    <input type="date" id="orderDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-lime-500 focus:ring focus:ring-lime-200 focus:ring-opacity-50 p-2">
                </div>
                <div>
                    <label for="orderNumber" class="block text-sm font-medium text-gray-700">លេខរៀងការកម្ម៉ង់:</label>
                    <div class="flex items-center mt-1">
                        <button type="button" onclick="decrementOrderNumber()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-l-md transition-colors">
                            -
                        </button>
                        <input type="text" id="orderNumber" class="flex-1 block w-full rounded-none border-gray-300 shadow-sm focus:border-lime-500 focus:ring focus:ring-lime-200 focus:ring-opacity-50 p-2 text-center" value="N00001">
                        <button type="button" onclick="incrementOrderNumber()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-r-md transition-colors">
                            +
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-6 mb-2">
                    <h3 class="text-xl font-bold" style="color: #006400;">បញ្ជីផ្លែឈើ</h3>
                    <div class="flex space-x-2">
                        <button type="button" onclick="showFruitModal('add')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-4 rounded-full text-xs transition-transform transform hover:scale-105" style="background-color: #38b000;">
                            ថែមប្រភេទមុខទំនិញ
                        </button>
                        <button type="button" onclick="showFruitModal('delete')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-4 rounded-full text-xs transition-transform transform hover:scale-105">
                            លុបប្រភេទទំនិញ
                        </button>
                        <button type="button" id="editPricesBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-4 rounded-full text-xs transition-transform transform hover:scale-105">
                            កែសម្រួលតម្លៃ
                        </button>
                        <button type="button" id="savePricesBtn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-4 rounded-full text-xs transition-transform transform hover:scale-105">
                            រក្សាទុកតម្លៃ
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-lime-100" style="background-color: #9ef01a;">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider" style="color: #004b23;">
                                    ជ្រើសរើស
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider" style="color: #004b23;">
                                    ឈ្មោះផ្លែឈើ
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider" style="color: #004b23;">
                                    តម្លៃ (៛/គីឡូ)
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider" style="color: #004b23;">
                                    បរិមាណ (គីឡូ)
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider" style="color: #004b23;">
                                    តម្លៃសរុប (៛)
                                </th>
                            </tr>
                        </thead>
                        <tbody id="fruitTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot class="bg-lime-100 font-bold" style="background-color: #9ef01a;">
                            <tr>
                                <td colspan="3" class="px-3 py-3 text-right text-sm text-lime-800" style="color: #004b23;">
                                    តម្លៃសរុប (គីឡូ):
                                </td>
                                <td id="totalKilo" class="px-3 py-3 text-left text-sm text-lime-800" style="color: #004b23;">0</td>
                                <td id="totalAmount" class="px-3 py-3 text-left text-sm text-lime-800" style="color: #004b23;">0៛</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="flex justify-between mt-6">
                    <button type="button" onclick="resetForm()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105">
                        សម្អាតទម្រង់
                    </button>
                    <div class="flex gap-4">
                        <button type="button" id="saveOrderBtn" onclick="saveOrder()" class="bg-lime-600 hover:bg-lime-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105" style="background-color: #007200;">
                            រក្សាទុកការកម្ម៉ង់
                        </button>
                        <button type="button" id="saveChangesBtn" onclick="saveChanges()" class="hidden bg-lime-600 hover:bg-lime-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105" style="background-color: #007200;">
                            រក្សាទុកការកែប្រែ
                        </button>
                        <button type="button" id="saveNewInvoiceBtn" onclick="saveNewInvoice()" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105" style="background-color: #008000;">
                            រក្សាទុកវិក្កយបត្រថ្មី
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <div id="invoice" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <button type="button" onclick="goToOrderTab()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-sm">
                    ត្រលប់ក្រោយ
                </button>
                <button type="button" onclick="resetInvoice()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-sm">
                    សម្អាតវិក្កយបត្រ
                </button>
            </div>
            <h2 class="text-2xl font-bold mb-4" style="color: #006400;">វិក្កយបត្រ</h2>
            <p class="text-center text-red-500 mb-4">
                សូមបំពេញទិន្នន័យក្នុងផ្នែក "កត់ត្រាការកម្ម៉ង់" ដើម្បីមើលវិក្កយបត្រ។
            </p>
            <div id="invoiceContent" class="hidden border rounded-lg p-6 bg-white shadow-md" style="border-color: #007200;">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-shrink-0 qr-code-box">
                        <img src="images/ABA_RIEL.jpg" alt="QR Code" class="mx-auto mb-2 w-24 h-24">
                        <p class="text-sm text-gray-300 mt-2" style="color: #8500006c;">ABA BANK</p>
                    </div>
                    <div class="text-center flex-1">
                        <p class="text-lg font-semibold" style="color: #004b23;">បញ្ញា</p>
                        <p class="text-sm text-gray-600">អាសយដ្ឋាន៖​​ ផ្សារបឹងកុក</p>
                        <p class="text-sm text-gray-600">លេខទូរស័ព្ទ៖​ 097 24 27 479 / 070 70 16 68</p>
                        <h3 class="text-xl font-bold mt-2" style="color: #006400;">វិក្កយបត្រ</h3>
                        <p class="text-sm mt-2">លេខរៀង: <span id="invoiceNumber" class="font-bold text-gray-900" style="color: #850000e1;"></span> | កាលបរិច្ឆេទ: <span id="invoiceDate" class="font-bold text-gray-900"></span></p>
                    </div>
                    <div class="flex-shrink-0 qr-code-box">
                        <img src="images/ABA_DOLAR.jpg" alt="QR Code 2" class="mx-auto mb-2 w-24 h-24">
                        <p class="text-sm text-gray-300 mt-2" style="color: #8500006c;">ABA BANK</p>
                    </div>
                </div>

                <div class="mb-4 mt-2 border-b-2 border-dashed border-gray-300 pb-2">
                    <p class="font-semibold text-gray-800 flex items-center justify-between">
                        <span>អតិថិជន: <span id="invoiceCustomerName" class="font-normal text-gray-900"></span></span>
                        <span class="flex items-center gap-1" style="color: #4267B2;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-facebook" viewBox="0 0 16 16">
                                <path d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75v-1.88c0-2.007 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.993h-1.013c-.98 0-1.29.61-1.29 1.25v1.51h2.218l-.354 2.036h-1.864v5.625C13.07 15.397 16 12.067 16 8.049z"/>
                            </svg>
                            <span class="text-sm font-medium">Ah Panha kpc</span>
                        </span>
                    </p>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-100" style="background-color: #ccff33;">
                            <tr>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">ល.រ</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">ឈ្មោះទំនិញ</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">បរិមាណ (គីឡូ)</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">ថ្លៃឯកតា</th>
                                <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">សរុប</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceItemsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                
                <div class="flex justify-end mt-4">
                    <div class="w-full md:w-1/2 space-y-2 border-t-2 pt-2" style="border-color: #007200;">
                        <div class="flex justify-between font-bold text-lg" style="color: #004b23;">
                            <span>សរុប (៛):</span>
                            <span id="invoiceTotalAmount">0៛</span>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between mt-6 text-center text-sm">
                    <div>
                        <p class="text-gray-700">ហត្ថលេខាអ្នកលក់</p>
                        <div class="w-32 h-14 signature-line mt-4"></div>
                    </div>
                    <div>
                        <p class="text-gray-700">ហត្ថលេខាអ្នកដឹក</p>
                        <div class="w-32 h-14 signature-line mt-4"></div>
                    </div>
                    <div>
                        <p class="text-gray-700">ហត្ថលេខាអ្នកទិញ</p>
                        <div class="w-32 h-14 signature-line mt-4"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-center mt-6">
                <button type="button" onclick="exportToPdf()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform hover:scale-105" style="background-color: #004b23;">
                    បម្លែងទៅជា PDF
                </button>
            </div>
        </div>

        <div id="preorders" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <button type="button" onclick="goToOrderTab()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-transform transform hover:scale-105 text-sm">
                    ត្រលប់ក្រោយ
                </button>
            </div>
            <h2 class="text-2xl font-bold mb-4" style="color: #006400;">បញ្ជីកម្ម៉ង់មុន</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                    <thead class="bg-lime-100" style="background-color: #9ef01a;">
                        <tr>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">ល.រ</th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">ម៉ោង</th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">ឈ្មោះអតិថិជន</th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">បញ្ជីទំនិញ</th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">តម្លៃសរុប (៛)</th>
                            <th scope="col" class="px-4 py-2 text-left text-xs font-bold text-gray-700 uppercase" style="color: #004b23;">សកម្មភាព</th>
                        </tr>
                    </thead>
                    <tbody id="preordersTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="messageBox" class="message-box bg-white p-6 rounded-xl shadow-2xl border border-gray-200 text-center w-80">
        <p id="messageText" class="text-gray-800 text-lg mb-4"></p>
        <button onclick="hideMessage()" class="bg-lime-600 hover:bg-lime-700 text-white px-6 py-2 rounded-full font-bold transition-colors" style="background-color: #008000;">
            យល់ព្រម
        </button>
    </div>

    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="hideCustomerModal()">&times;</span>
            <h2 id="customerModalTitle" class="text-2xl font-bold text-lime-700 mb-4" style="color: #006400;"></h2>
            <div id="addCustomerForm" class="space-y-4">
                <div>
                    <label for="newCustomerName" class="block text-sm font-medium text-gray-700">ឈ្មោះអតិថិជនថ្មី:</label>
                    <input type="text" id="newCustomerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="បញ្ចូលឈ្មោះអតិថិជន...">
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="saveNewCustomer()" class="bg-lime-600 hover:bg-lime-700 text-white font-bold py-2 px-6 rounded-full shadow-lg" style="background-color: #008000;">
                        រក្សារទុក
                    </button>
                </div>
            </div>
            <div id="deleteCustomerForm" class="space-y-4 hidden">
                <div>
                    <label for="deleteCustomerName" class="block text-sm font-medium text-gray-700">ជ្រើសរើសអតិថិជនដែលត្រូវលុប:</label>
                    <select id="deleteCustomerName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </select>
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="deleteSelectedCustomer()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow-lg">
                        លុប
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="fruitModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="hideFruitModal()">&times;</span>
            <h2 id="fruitModalTitle" class="text-2xl font-bold text-lime-700 mb-4" style="color: #006400;"></h2>
            <div id="addFruitForm" class="space-y-4">
                <div>
                    <label for="newFruitName" class="block text-sm font-medium text-gray-700">ឈ្មោះផ្លែឈើ:</label>
                    <input type="text" id="newFruitName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="បញ្ចូលឈ្មោះផ្លែឈើ...">
                </div>
                <div>
                    <label for="newFruitPrice" class="block text-sm font-medium text-gray-700">តម្លៃ (៛/គីឡូ):</label>
                    <input type="number" id="newFruitPrice" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="បញ្ចូលតម្លៃ...">
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="saveNewFruit()" class="bg-lime-600 hover:bg-lime-700 text-white font-bold py-2 px-6 rounded-full shadow-lg" style="background-color: #008000;">
                        រក្សារទុក
                    </button>
                </div>
            </div>
            <div id="deleteFruitForm" class="space-y-4 hidden">
                <div>
                    <label for="deleteFruitName" class="block text-sm font-medium text-gray-700">ជ្រើសរើសផ្លែឈើដែលត្រូវលុប:</label>
                    <select id="deleteFruitName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                    </select>
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="deleteSelectedFruit()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow-lg">
                        លុប
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="pdf-container" class="pdf-export-container">
        </div>


    <script>
        // Data keys for localStorage
        const customerNamesKey = 'fruitCustomerNames';
        const fruitDataKey = 'fruitProducts';
        const localStorageKey = 'fruitPreorders';
        const lastOrderNumberKey = 'lastOrderNumber';

        // Initial default data if not found in localStorage
        const defaultCustomerNames = [
            "ចែមំុ", "ចែឆេង", "ឣុីមួយ", "ឣុីងិម", "ចែឣូន", "ចែពេជ្រ", "ចែទន្លេបិទ", "ចែហួ", "ចែនី", "ចែភារ៉ា",
            "ចែភ័ក្រ្ត", "ចែហ៊ាង", "ឣ៊ំទន្លេបិទ", "ឣុីខេង", "ឣុីភាពវត្ថឣង្គរ", "ឣុីណាង", "ចែនាងផ្សារធំ", "ស្រីលីស",
            "ឣុីណាផ្សារធំ", "ចែឣូនផ្សារធំ", "ចែសុីណាត", "ចែផល", "ប្ឣូនចែផល", "ឣ៊ំហាន", "ឣុីធី", "ឣុីផល្លា",
            "ចែណៃ", "ចែស្រស់", "ចែវ៉ាត", "ចែហុង", "ចែរ័ត្ន", "ឣុីភ័ណ្ឌ", "ចែសុខជា", "ចែសុខណា", "ឣ៊ំចន្ធូ",
            "ឣ៊ំណុច", "ចែសុខលី", "ចែទី", "ចែរុណ", "ចែចំរើន", "ចែនីព្រែកចាន់", "ពូបាន", "ឣុីថា", "តាវ៉ែនតា",
            "ចែធា", "ចែឡែន", "ឣុីធឿន", "ឣុីមំុផ្សារធំ", "ចែឡា", "តាកៅ", "ចែភាពផ្សារធំ", "ចែថុល 7មករា",
            "ចែលាប", "ចែនិត", "ចែឣ៊ាង", "ចែនាងបឹងកុក", "ឣុីមំុបឹងកុក", "យាយហ៊ន់", "យាយថេង", "ឣ៊ំណាង", "ឣុីចន្ថា"
        ];
        const defaultFruitData = [
            { name: "មៀនខ្មែរ", price: 20000 },
            { name: "មៀនយួន", price: 20000 },
            { name: "ស្រកានាគស", price: 7000 },
            { name: "ស្រកានាគក្រហម", price: 7000 },
            { name: "ស្រកានាគគីមហុង", price: 7000 },
            { name: "ប័រ", price: 30000 },
            { name: "ក្រូចពោធិ៍សាត់", price: 20000 },
            { name: "ក្រូចអាហ្សង់ទិន", price: 20000 },
            { name: "ទំពាំងបាយជូ វែង", price: 20000 },
            { name: "ទំពាំងបាយជូ ធំ", price: 20000 },
            { name: "ទំពាំងបាយជូ ខ្មៅ", price: 20000 },
            { name: "ទំពាំងបាយជូ ខៀវ", price: 20000 },
            { name: "ទំពាំងបាយជូ ពងត្រី", price: 20000 },
            { name: "ប៉ោម", price: 30000 },
            { name: "yala", price: 100000 },
            { name: "សារីស", price: 30000 },
            { name: "សារីខៀវ", price: 30000 },
            { name: "ស្តប៊ឺរី", price: 2000 },
            { name: "ឈើរី", price: 150000 },
            { name: "ល្មើ", price: 12000 },
            { name: "មង្ឃុត", price: 3000 },
            { name: "សាវម៉ាវ", price: 15000 },
            { name: "ក្រូចតែ", price: 7000 },
            { name: "ផាសិន", price: 20000 },
            { name: "កន្ទឹម", price: 30000 },
            { name: "ភ្ញៀវ", price: 10000 }
        ];

        let selectedOrder = null;
        let editingOrderId = null;

        // Function to get and set data from localStorage, with default values
        function getLocalStorageData(key, defaultValue) {
            const data = localStorage.getItem(key);
            if (data) {
                return JSON.parse(data);
            }
            localStorage.setItem(key, JSON.stringify(defaultValue));
            return defaultValue;
        }

        // Load initial data
        let customerNames = getLocalStorageData(customerNamesKey, defaultCustomerNames);
        let fruitData = getLocalStorageData(fruitDataKey, defaultFruitData);
        
        // Function to show a custom message box
        function showMessage(message) {
            document.getElementById('messageText').textContent = message;
            document.getElementById('messageBox').style.display = 'block';
        }

        // Function to hide the custom message box
        function hideMessage() {
            document.getElementById('messageBox').style.display = 'none';
        }

        // Function to show the customer modal (add or delete)
        function showCustomerModal(mode) {
            const modal = document.getElementById('customerModal');
            const title = document.getElementById('customerModalTitle');
            const addForm = document.getElementById('addCustomerForm');
            const deleteForm = document.getElementById('deleteCustomerForm');
            
            if (mode === 'add') {
                title.textContent = 'បន្ថែមឈ្មោះអតិថិជនថ្មី';
                addForm.classList.remove('hidden');
                deleteForm.classList.add('hidden');
                document.getElementById('newCustomerName').value = '';
            } else if (mode === 'delete') {
                title.textContent = 'លុបឈ្មោះអតិថិជន';
                addForm.classList.add('hidden');
                deleteForm.classList.remove('hidden');
                populateCustomerDeleteDropdown();
            }
            modal.style.display = 'block';
        }

        // Function to hide the customer modal
        function hideCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
        }

        // Function to save a new customer
        function saveNewCustomer() {
            const newName = document.getElementById('newCustomerName').value.trim();
            if (newName && !customerNames.includes(newName)) {
                customerNames.push(newName);
                customerNames.sort(); // Sort alphabetically
                localStorage.setItem(customerNamesKey, JSON.stringify(customerNames));
                populateCustomerDropdown();
                hideCustomerModal();
                showMessage('ឈ្មោះអតិថិជនថ្មីត្រូវបានរក្សាទុកដោយជោគជ័យ!');
            } else {
                showMessage('សូមបញ្ចូលឈ្មោះអតិថិជនថ្មីដែលមិនទាន់មានក្នុងបញ្ជី។');
            }
        }
        
        // Function to populate the customer delete dropdown
        function populateCustomerDeleteDropdown() {
            const select = document.getElementById('deleteCustomerName');
            select.innerHTML = '';
            customerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // Function to delete a selected customer
        function deleteSelectedCustomer() {
            const nameToDelete = document.getElementById('deleteCustomerName').value;
            if (nameToDelete) {
                const updatedNames = customerNames.filter(name => name !== nameToDelete);
                customerNames = updatedNames;
                localStorage.setItem(customerNamesKey, JSON.stringify(customerNames));
                populateCustomerDropdown();
                hideCustomerModal();
                showMessage(`អតិថិជន "${nameToDelete}" ត្រូវបានលុបដោយជោគជ័យ!`);
            } else {
                showMessage('សូមជ្រើសរើសអតិថិជនដើម្បីលុប។');
            }
        }

        // Function to show the fruit modal (add or delete)
        function showFruitModal(mode) {
            const modal = document.getElementById('fruitModal');
            const title = document.getElementById('fruitModalTitle');
            const addForm = document.getElementById('addFruitForm');
            const deleteForm = document.getElementById('deleteFruitForm');

            if (mode === 'add') {
                title.textContent = 'ថែមប្រភេទមុខទំនិញ';
                addForm.classList.remove('hidden');
                deleteForm.classList.add('hidden');
                document.getElementById('newFruitName').value = '';
                document.getElementById('newFruitPrice').value = '';
            } else if (mode === 'delete') {
                title.textContent = 'លុបប្រភេទទំនិញ';
                addForm.classList.add('hidden');
                deleteForm.classList.remove('hidden');
                populateFruitDeleteDropdown();
            }
            modal.style.display = 'block';
        }

        // Function to hide the fruit modal
        function hideFruitModal() {
            document.getElementById('fruitModal').style.display = 'none';
        }

        // Function to save a new fruit
        function saveNewFruit() {
            const newName = document.getElementById('newFruitName').value.trim();
            const newPrice = parseFloat(document.getElementById('newFruitPrice').value);
            if (newName && !isNaN(newPrice) && newPrice >= 0) {
                const existingFruit = fruitData.find(f => f.name === newName);
                if (existingFruit) {
                    showMessage('ផ្លែឈើនេះមានរួចហើយ។ សូមកែតម្លៃជំនួសវិញ។');
                } else {
                    fruitData.push({ name: newName, price: newPrice });
                    fruitData.sort((a, b) => a.name.localeCompare(b.name, 'km-KH')); // Sort alphabetically
                    localStorage.setItem(fruitDataKey, JSON.stringify(fruitData));
                    renderFruitTable();
                    hideFruitModal();
                    showMessage('ប្រភេទមុខទំនិញថ្មីត្រូវបានរក្សាទុកដោយជោគជ័យ!');
                }
            } else {
                showMessage('សូមបំពេញព័ត៌មានផ្លែឈើឲ្យបានត្រឹមត្រូវ។');
            }
        }
        
        // Function to populate the fruit delete dropdown
        function populateFruitDeleteDropdown() {
            const select = document.getElementById('deleteFruitName');
            select.innerHTML = '';
            fruitData.forEach(fruit => {
                const option = document.createElement('option');
                option.value = fruit.name;
                option.textContent = fruit.name;
                select.appendChild(option);
            });
        }

        // Function to delete a selected fruit
        function deleteSelectedFruit() {
            const nameToDelete = document.getElementById('deleteFruitName').value;
            if (nameToDelete) {
                const updatedData = fruitData.filter(fruit => fruit.name !== nameToDelete);
                fruitData = updatedData;
                localStorage.setItem(fruitDataKey, JSON.stringify(fruitData));
                renderFruitTable();
                hideFruitModal();
                showMessage(`ប្រភេទមុខទំនិញ "${nameToDelete}" ត្រូវបានលុបដោយជោគជ័យ!`);
            } else {
                showMessage('សូមជ្រើសរើសផ្លែឈើដើម្បីលុប។');
            }
        }

        // Function to toggle price editing mode
        function togglePriceEditing(enable) {
            const editBtn = document.getElementById('editPricesBtn');
            const saveBtn = document.getElementById('savePricesBtn');
            const priceCells = document.querySelectorAll('.fruit-price-cell');
            
            if (enable) {
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                priceCells.forEach(cell => {
                    const price = parseFloat(cell.dataset.price);
                    const index = cell.dataset.index;
                    cell.innerHTML = `
                        <input type="number" min="0" value="${price}" data-index="${index}" class="price-input w-24 p-1 border rounded-md text-center bg-gray-50 focus:bg-white focus:outline-none">
                    `;
                });
            } else {
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                priceCells.forEach(cell => {
                    const price = parseFloat(cell.dataset.price);
                    cell.innerHTML = `${price.toLocaleString('km-KH')}៛`;
                });
            }
        }
        
        // Event listeners for the price buttons
        document.getElementById('editPricesBtn').addEventListener('click', () => togglePriceEditing(true));
        document.getElementById('savePricesBtn').addEventListener('click', () => {
            savePricesToStorage();
            renderFruitTable(); // Re-render the table to show updated prices
            togglePriceEditing(false); // Disable editing mode
        });

        // Function to save custom prices to localStorage
        function savePricesToStorage() {
            document.querySelectorAll('.price-input').forEach(input => {
                const index = input.dataset.index;
                const newPrice = parseFloat(input.value);
                if (!isNaN(newPrice) && newPrice >= 0) {
                    fruitData[index].price = newPrice;
                }
            });
            localStorage.setItem(fruitDataKey, JSON.stringify(fruitData));
            showMessage('តម្លៃត្រូវបានរក្សាទុកដោយជោគជ័យ!');
        }

        // Function to create and render the fruit table in the order form
        function renderFruitTable() {
            const tbody = document.getElementById('fruitTableBody');
            tbody.innerHTML = '';
            fruitData.forEach((fruit, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                        <input type="checkbox" id="fruitCheck${index}" data-index="${index}" class="form-checkbox h-4 w-4 rounded" style="color: #008000;">
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-900">
                        ${fruit.name}
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 fruit-price-cell" data-price="${fruit.price}" data-index="${index}">
                        ${fruit.price.toLocaleString('km-KH')}៛
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">
                        <input type="number" min="0" value="0" data-index="${index}" class="kilo-input w-20 p-1 border rounded-md text-center bg-gray-50 focus:bg-white focus:outline-none disabled:bg-gray-200" disabled>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500 total-row-amount">
                        0៛
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners to checkboxes and kilo inputs
            document.querySelectorAll('.kilo-input').forEach(input => {
                input.addEventListener('input', updateOrderTotals);
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = e.target.dataset.index;
                    const kiloInput = document.querySelector(`.kilo-input[data-index="${index}"]`);
                    kiloInput.disabled = !e.target.checked;
                    if (!e.target.checked) {
                        kiloInput.value = 0;
                    }
                    updateOrderTotals();
                });
            });
        }

        // Function to update the total kilos and total amount in the form
        function updateOrderTotals() {
            let totalKilos = 0;
            let totalAmount = 0;
            const rows = document.getElementById('fruitTableBody').children;
            
            for (let i = 0; i < rows.length; i++) {
                const checkbox = rows[i].querySelector('input[type="checkbox"]');
                const kiloInput = rows[i].querySelector('.kilo-input');
                const totalRowAmountSpan = rows[i].querySelector('.total-row-amount');
                
                const kilos = checkbox.checked ? parseFloat(kiloInput.value) || 0 : 0;
                const price = fruitData[i].price;
                const rowTotal = kilos * price;

                totalKilos += kilos;
                totalAmount += rowTotal;

                totalRowAmountSpan.textContent = `${rowTotal.toLocaleString('km-KH')}៛`;
            }

            document.getElementById('totalKilo').textContent = totalKilos.toLocaleString('km-KH');
            document.getElementById('totalAmount').textContent = `${totalAmount.toLocaleString('km-KH')}៛`;
        }
        
        // Function to reset the order form
        function resetForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('orderDate').value = '';

            document.querySelectorAll('#fruitTableBody tr').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                const kiloInput = row.querySelector('.kilo-input');
                checkbox.checked = false;
                kiloInput.value = '0';
                kiloInput.disabled = true;
            });

            updateOrderTotals();
            loadAndSetOrderNumber();
            editingOrderId = null;
            document.getElementById('saveOrderBtn').classList.remove('hidden');
            document.getElementById('saveChangesBtn').classList.add('hidden');
            document.getElementById('saveNewInvoiceBtn').classList.add('hidden');
        }

        // Function to save a new order
        function saveOrder() {
            const customerName = document.getElementById('customerName').value;
            const orderDate = document.getElementById('orderDate').value;
            const orderNumber = document.getElementById('orderNumber').value;
            const items = [];
            let totalKilos = 0;
            let totalAmount = 0;

            document.querySelectorAll('#fruitTableBody tr').forEach((row, index) => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    const kiloInput = row.querySelector('.kilo-input');
                    const fruit = fruitData[index];
                    const kilos = parseFloat(kiloInput.value);
                    const itemTotal = kilos * fruit.price;

                    items.push({
                        name: fruit.name,
                        kilos: kilos,
                        price: fruit.price,
                        total: itemTotal
                    });

                    totalKilos += kilos;
                    totalAmount += itemTotal;
                }
            });

            if (!customerName || !orderDate || !orderNumber || items.length === 0) {
                showMessage('សូមបំពេញព័ត៌មានអតិថិជន និងជ្រើសរើសផ្លែឈើយ៉ាងហោចណាស់មួយប្រភេទ។');
                return;
            }

            const newOrder = {
                id: Date.now(),
                customerName,
                orderDate,
                orderNumber,
                items,
                totalKilos,
                totalAmount,
                timestamp: new Date().toISOString()
            };
            
            const existingOrders = JSON.parse(localStorage.getItem(localStorageKey)) || [];
            existingOrders.push(newOrder);
            localStorage.setItem(localStorageKey, JSON.stringify(existingOrders));

            const currentOrderNum = parseInt(orderNumber.replace('N', ''), 10);
            localStorage.setItem(lastOrderNumberKey, currentOrderNum);

            showMessage('ការកម្ម៉ង់ត្រូវបានរក្សាទុកដោយជោគជ័យ!');
            
            selectedOrder = newOrder;

            document.querySelector('[data-tab="invoice"]').click();
        }

        // Function to save changes to an existing order
        function saveChanges() {
            if (!editingOrderId) {
                showMessage('មិនមានការកម្ម៉ង់ណាមួយត្រូវបានជ្រើសរើសដើម្បីកែប្រែទេ។');
                return;
            }

            const customerName = document.getElementById('customerName').value;
            const orderDate = document.getElementById('orderDate').value;
            const orderNumber = document.getElementById('orderNumber').value;
            const items = [];
            let totalKilos = 0;
            let totalAmount = 0;

            document.querySelectorAll('#fruitTableBody tr').forEach((row, index) => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    const kiloInput = row.querySelector('.kilo-input');
                    const fruit = fruitData[index];
                    const kilos = parseFloat(kiloInput.value);
                    const itemTotal = kilos * fruit.price;

                    items.push({
                        name: fruit.name,
                        kilos: kilos,
                        price: fruit.price,
                        total: itemTotal
                    });

                    totalKilos += kilos;
                    totalAmount += itemTotal;
                }
            });

            if (!customerName || !orderDate || !orderNumber || items.length === 0) {
                showMessage('សូមបំពេញព័ត៌មានអតិថិជន និងជ្រើសរើសផ្លែឈើយ៉ាងហោចណាស់មួយប្រភេទ។');
                return;
            }
            
            const orders = JSON.parse(localStorage.getItem(localStorageKey)) || [];
            const orderIndex = orders.findIndex(order => order.id === editingOrderId);
            if (orderIndex !== -1) {
                orders[orderIndex] = {
                    ...orders[orderIndex],
                    customerName,
                    orderDate,
                    orderNumber,
                    items,
                    totalKilos,
                    totalAmount
                };
                localStorage.setItem(localStorageKey, JSON.stringify(orders));
                showMessage('ការកម្ម៉ង់ត្រូវបានកែប្រែដោយជោគជ័យ!');
                resetForm();
                goToPreordersTab();
            } else {
                showMessage('មិនអាចរកឃើញការកម្ម៉ង់ដើម្បីកែប្រែទេ។');
            }
        }
        
        // Function to create a new invoice from current form data
        function saveNewInvoice() {
            const customerName = document.getElementById('customerName').value;
            const orderDate = document.getElementById('orderDate').value;
            const orderNumber = document.getElementById('orderNumber').value;
            const items = [];
            let totalKilos = 0;
            let totalAmount = 0;
        
            document.querySelectorAll('#fruitTableBody tr').forEach((row, index) => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    const kiloInput = row.querySelector('.kilo-input');
                    const fruit = fruitData[index];
                    const kilos = parseFloat(kiloInput.value);
                    const itemTotal = kilos * fruit.price;
        
                    items.push({
                        name: fruit.name,
                        kilos: kilos,
                        price: fruit.price,
                        total: itemTotal
                    });
        
                    totalKilos += kilos;
                    totalAmount += itemTotal;
                }
            });
        
            if (!customerName || !orderDate || !orderNumber || items.length === 0) {
                showMessage('សូមបំពេញព័ត៌មានអតិថិជន និងជ្រើសរើសផ្លែឈើយ៉ាងហោចណាស់មួយប្រភេទ។');
                return;
            }
        
            const tempOrder = {
                customerName,
                orderDate,
                orderNumber,
                items,
                totalKilos,
                totalAmount,
            };
        
            selectedOrder = tempOrder;
            showMessage('វិក្កយបត្រថ្មីត្រូវបានបង្កើត!');
            document.querySelector('[data-tab="invoice"]').click();
        }

        // Function to load an order into the form for editing
        function editOrder(id) {
            const orders = JSON.parse(localStorage.getItem(localStorageKey)) || [];
            const orderToEdit = orders.find(order => order.id === id);
            
            if (orderToEdit) {
                document.getElementById('customerName').value = orderToEdit.customerName;
                document.getElementById('orderDate').value = orderToEdit.orderDate;
                document.getElementById('orderNumber').value = orderToEdit.orderNumber;
                
                renderFruitTable();

                orderToEdit.items.forEach(item => {
                    const fruitIndex = fruitData.findIndex(f => f.name === item.name);
                    if (fruitIndex !== -1) {
                        const checkbox = document.getElementById(`fruitCheck${fruitIndex}`);
                        checkbox.checked = true;
                        
                        const kiloInput = document.querySelector(`.kilo-input[data-index="${fruitIndex}"]`);
                        kiloInput.disabled = false;
                        kiloInput.value = item.kilos;
                    }
                });

                updateOrderTotals();
                editingOrderId = id;
                document.getElementById('saveOrderBtn').classList.add('hidden');
                document.getElementById('saveChangesBtn').classList.remove('hidden');
                document.getElementById('saveNewInvoiceBtn').classList.remove('hidden');
                goToOrderTab();
            } else {
                showMessage('មិនអាចរកឃើញការកម្ម៉ង់ដើម្បីកែប្រែទេ។');
            }
        }

        // Function to delete an order by ID
        function deleteOrder(id) {
            const orders = JSON.parse(localStorage.getItem(localStorageKey)) || [];
            if (orders.length > 0) {
                const updatedOrders = orders.filter(order => order.id !== id);
                localStorage.setItem(localStorageKey, JSON.stringify(updatedOrders));
                renderPreorders();
                showMessage('ការកម្ម៉ង់ត្រូវបានលុបដោយជោគជ័យ!');
            }
        }

        // Function to render the invoice based on saved data
        function renderInvoice() {
            const invoiceContentDiv = document.getElementById('invoiceContent');
            const placeholderText = document.querySelector('#invoice .text-red-500');
            const totalAmountSpan = document.getElementById('invoiceTotalAmount');

            if (!selectedOrder) {
                if (invoiceContentDiv) invoiceContentDiv.classList.add('hidden');
                if (placeholderText) placeholderText.classList.remove('hidden');
                if (totalAmountSpan) totalAmountSpan.textContent = '0៛';
                return;
            }
            
            if (invoiceContentDiv) invoiceContentDiv.classList.remove('hidden');
            if (placeholderText) placeholderText.classList.add('hidden');
            
            if (document.getElementById('invoiceCustomerName')) document.getElementById('invoiceCustomerName').textContent = selectedOrder.customerName;
            if (document.getElementById('invoiceDate')) document.getElementById('invoiceDate').textContent = selectedOrder.orderDate;
            if (document.getElementById('invoiceNumber')) document.getElementById('invoiceNumber').textContent = selectedOrder.orderNumber;
            
            const invoiceTableBody = document.getElementById('invoiceItemsTableBody');
            if (invoiceTableBody) {
                invoiceTableBody.innerHTML = '';
                
                selectedOrder.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-2 text-sm text-gray-900">${index + 1}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.name}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.kilos.toLocaleString('km-KH')}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.price.toLocaleString('km-KH')}៛</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.total.toLocaleString('km-KH')}៛</td>
                    `;
                    invoiceTableBody.appendChild(row);
                });
            }
            
            if (totalAmountSpan) totalAmountSpan.textContent = `${selectedOrder.totalAmount.toLocaleString('km-KH')}៛`;
        }
        
        // Function to reset the invoice tab
        function resetInvoice() {
            selectedOrder = null;
            document.getElementById('invoiceContent').classList.add('hidden');
            document.querySelector('#invoice .text-red-500').classList.remove('hidden');
        }

        // Function to render the list of pre-orders from localStorage
        function renderPreorders() {
            const preordersTableBody = document.getElementById('preordersTableBody');
            preordersTableBody.innerHTML = ''; // Clear table
            
            const orders = JSON.parse(localStorage.getItem(localStorageKey)) || [];
            
            if (orders.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="6" class="px-4 py-2 text-center text-gray-500">មិនទាន់មានការកម្ម៉ង់ណាមួយត្រូវបានរក្សាទុកទេ។</td>`;
                preordersTableBody.appendChild(emptyRow);
                return;
            }
            
            orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            orders.forEach((order) => {
                const itemNames = order.items.map(item => `${item.name} (${item.kilos}គីឡូ)`).join(', ');
                const orderTime = new Date(order.timestamp).toLocaleString('km-KH', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric' });
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900 cursor-pointer" onclick="viewOrderDetails(${order.id})">${order.orderNumber}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${orderTime}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${order.customerName}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${itemNames}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${order.totalAmount.toLocaleString('km-KH')}៛</td>
                    <td class="px-4 py-2 text-sm text-gray-900 flex gap-2">
                        <button onclick="editOrder(${order.id})" class="text-blue-500 hover:text-blue-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.832 9.77a.5.5 0 01-.176.22l-1.63 1.63a.5.5 0 00-.176.22L7.382 17.5a.5.5 0 00.612.612l2.356-.725a.5.5 0 00.22-.176l1.63-1.63a.5.5 0 00.176-.22l.725-2.356a.5.5 0 00-.612-.612l-2.356.725z" />
                            </svg>
                        </button>
                        <button onclick="deleteOrder(${order.id})" class="text-red-500 hover:text-red-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button onclick="exportTwoUpLandscape(${order.id})" class="text-green-500 hover:text-green-700 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414-1.414L9 8.586V4a1 1 0 112 0v4.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                preordersTableBody.appendChild(row);
            });
        }
        
        // Function to view order details when clicking on an order number
        function viewOrderDetails(id) {
            const orders = JSON.parse(localStorage.getItem(localStorageKey)) || [];
            const order = orders.find(o => o.id === id);
            if (order) {
                selectedOrder = order;
                document.querySelector('[data-tab="invoice"]').click();
            } else {
                showMessage('Không tìm thấy đơn hàng này.');
            }
        }

        // Function to go back to the order tab
        function goToOrderTab() {
            document.querySelector('[data-tab="order"]').click();
        }

        // Function to go to the pre-orders tab
        function goToPreordersTab() {
            document.querySelector('[data-tab="preorders"]').click();
        }

        // Function to export two invoices on a single landscape A4 page
        function exportTwoUpLandscape(id) {
            let orderToExport = selectedOrder;
            if (id) {
                const orders = JSON.parse(localStorage.getItem(localStorageKey)) || [];
                orderToExport = orders.find(o => o.id === id);
            }

            if (!orderToExport) {
                showMessage('Vui lòng ghi lại đơn hàng trước khi xuất ra PDF!');
                return;
            }
            
            const invoiceContentDiv = document.getElementById('invoiceContent');
            if (invoiceContentDiv) {
                document.getElementById('invoiceCustomerName').textContent = orderToExport.customerName;
                document.getElementById('invoiceDate').textContent = orderToExport.orderDate;
                document.getElementById('invoiceNumber').textContent = orderToExport.orderNumber;
                
                const invoiceTableBody = document.getElementById('invoiceItemsTableBody');
                invoiceTableBody.innerHTML = '';
                orderToExport.items.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-2 text-sm text-gray-900">${index + 1}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.name}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.kilos.toLocaleString('km-KH')}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.price.toLocaleString('km-KH')}៛</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${item.total.toLocaleString('km-KH')}៛</td>
                    `;
                    invoiceTableBody.appendChild(row);
                });
                document.getElementById('invoiceTotalAmount').textContent = `${orderToExport.totalAmount.toLocaleString('km-KH')}៛`;
            }

            const pdfContainer = document.getElementById('pdf-container');
            const invoiceHtml = invoiceContentDiv.innerHTML;

            const invoice1 = document.createElement('div');
            invoice1.classList.add('pdf-invoice-content');
            invoice1.innerHTML = invoiceHtml;
            
            const invoice2 = document.createElement('div');
            invoice2.classList.add('pdf-invoice-content');
            invoice2.innerHTML = invoiceHtml;
            
            pdfContainer.innerHTML = '';
            pdfContainer.appendChild(invoice1);
            
            const divider = document.createElement('div');
            divider.classList.add('dotted-divider');
            pdfContainer.appendChild(divider);

            pdfContainer.appendChild(invoice2);

            pdfContainer.classList.add('visible');
            document.getElementById('main-app').style.display = 'none';

            setTimeout(() => {
                html2pdf().set({
                    margin: 0,
                    filename: `វិក្កយបត្រ_កម្ម៉ង់លេខ_${orderToExport.orderNumber}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2, 
                        logging: false,
                        scrollY: 0,
                        scrollX: 0,
                        useCORS: true
                    },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
                }).from(pdfContainer).save().finally(() => {
                    pdfContainer.innerHTML = '';
                    pdfContainer.classList.remove('visible');
                    document.getElementById('main-app').style.display = 'block';
                });
            }, 100);
        }

        // Function to populate the customer name dropdown
        function populateCustomerDropdown() {
            const select = document.getElementById('customerName');
            select.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'ជ្រើសរើសអតិថិជន...';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);
            
            customerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        
        // Function to get and set the next order number
        function loadAndSetOrderNumber() {
            const lastNumber = parseInt(localStorage.getItem(lastOrderNumberKey)) || 0;
            const nextNumber = lastNumber + 1;
            const formattedNumber = 'N' + String(nextNumber).padStart(5, '0');
            const orderNumberInput = document.getElementById('orderNumber');
            orderNumberInput.value = formattedNumber;
        }

        // Function to increment the numeric part of the order number
        function incrementOrderNumber() {
            const orderNumberInput = document.getElementById('orderNumber');
            const currentValue = orderNumberInput.value;
            const numericPart = parseInt(currentValue.replace('N', '')) || 0;
            const nextNumber = numericPart + 1;
            orderNumberInput.value = 'N' + String(nextNumber).padStart(5, '0');
        }

        // Function to decrement the numeric part of the order number
        function decrementOrderNumber() {
            const orderNumberInput = document.getElementById('orderNumber');
            const currentValue = orderNumberInput.value;
            const numericPart = parseInt(currentValue.replace('N', '')) || 0;
            const prevNumber = Math.max(1, numericPart - 1); // Ensure it doesn't go below 1
            orderNumberInput.value = 'N' + String(prevNumber).padStart(5, '0');
        }

        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.style.backgroundColor = '';
                    btn.style.color = '#007200';
                    btn.style.borderColor = 'transparent';
                    btn.classList.add('hover:bg-lime-50');
                });
                
                document.getElementById(tab).classList.add('active');
                button.style.backgroundColor = '#70e000';
                button.style.color = 'white';
                button.style.borderColor = '#008000';
                button.classList.remove('hover:bg-lime-50');
                
                if (tab === 'invoice') {
                    renderInvoice();
                } else if (tab === 'preorders') {
                    renderPreorders();
                }
            });
        });

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            populateCustomerDropdown();
            loadAndSetOrderNumber();
            renderFruitTable();
        });
    </script>
</body>
</html>
